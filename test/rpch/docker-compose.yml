version: "3"
x-host-access: &hostaccess
  extra_hosts:
    - "host.docker.internal:host-gateway"
x-exit-service: &exit
  image: europe-west6-docker.pkg.dev/rpch-375921/rpch/exit-node@sha256:3b23343a7f7d00ed8a91338b2f28bd3c78779d8c345076f9d368a792ac24325c
  restart: unless-stopped
  volumes:
    - exit-node-data:/tmp
  command: "node apps/exit-node/build/index.js"
volumes:
  postgres-data:
  exit-node-data:
services:
  db:
    image: postgres:14.1-alpine
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
  funding-service:
    image: europe-west6-docker.pkg.dev/rpch-375921/rpch/funding-service@sha256:8df2f079ab786401f55d05c61e338795687ce24df2f45ca9285e48e6b59036ef
    depends_on:
      - db
    restart: unless-stopped
    ports:
      - "${FUNDING_SERVICE_PORT}:${FUNDING_SERVICE_PORT}"
    environment:
      - DEBUG=${DEBUG}
      - PORT=${FUNDING_SERVICE_PORT}
      - SECRET_KEY=${SECRET_KEY}
      - WALLET_PRIV_KEY=${FUNDING_SERVICE_PRIVATE_KEY}
      - DB_CONNECTION_URL=postgresql://postgres:postgres@db:${DB_PORT}
      - FORCE_CHAIN_ID=31337
      - FORCE_RPC_URL=${RPC_PROVIDER}
      - FORCE_SMART_CONTRACT_ADDRESS=${FORCE_SMART_CONTRACT_ADDRESS}
  discovery-platform:
    image: europe-west6-docker.pkg.dev/rpch-375921/rpch/discovery-platform@sha256:9eed7eb1c9bdb9c7deaa330a64071aa3d3d8af673111045f4d7157286908e74c
    depends_on:
      - db
    restart: unless-stopped
    ports:
      - "${DISCOVERY_PLATFORM_PORT}:${DISCOVERY_PLATFORM_PORT}"
    environment:
      - DEBUG=${DEBUG}
      - PORT=${DISCOVERY_PLATFORM_PORT}
      - SECRET_KEY=${SECRET_KEY}
      - DB_CONNECTION_URL=postgresql://postgres:postgres@db:${DB_PORT}
      - FUNDING_SERVICE_URL=http://funding-service:${FUNDING_SERVICE_PORT}
      - SKIP_CHECK_COMMITMENT=${SKIP_CHECK_COMMITMENT}
  manager:
    !!merge <<: *hostaccess
    image: europe-west6-docker.pkg.dev/rpch-375921/rpch/manager@sha256:ed7bd24fd4004a4889273cfbb559e4d461bcb15bfc6daac6abd519267c95d6b2
    restart: unless-stopped
    ports:
      - "${MANAGER_PORT}:${MANAGER_PORT}"
    environment:
      - DEBUG=${DEBUG}
      - PORT=${MANAGER_PORT}
  exit-1:
    !!merge <<: *hostaccess
    !!merge <<: *exit
    environment:
      - HOPRD_API_ENDPOINT=http://host.docker.internal:13301
      - DEBUG=${DEBUG:-"rpch*"}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PRIVATE_KEY=${EXIT_NODE_PRIV_KEY_1}
    entrypoint: ["/bin/wait-for", "http://${HOPRD_API_TOKEN}@host.docker.internal:13301/api/v2/account/addresses", "-t", "300", "--", "/sbin/tini", "--"]
  exit-2:
    !!merge <<: *hostaccess
    !!merge <<: *exit
    environment:
      - HOPRD_API_ENDPOINT=http://host.docker.internal:13302
      - DEBUG=${DEBUG:-"rpch*"}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PRIVATE_KEY=${EXIT_NODE_PRIV_KEY_2}
    entrypoint: ["/bin/wait-for", "http://${HOPRD_API_TOKEN}@host.docker.internal:13302/api/v2/account/addresses", "-t", "300", "--", "/sbin/tini", "--"]
  exit-3:
    !!merge <<: *hostaccess
    !!merge <<: *exit
    environment:
      - HOPRD_API_ENDPOINT=http://host.docker.internal:13303
      - DEBUG=${DEBUG:-"rpch*"}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PRIVATE_KEY=${EXIT_NODE_PRIV_KEY_3}
    entrypoint: ["/bin/wait-for", "http://${HOPRD_API_TOKEN}@host.docker.internal:13303/api/v2/account/addresses", "-t", "300", "--", "/sbin/tini", "--"]
  exit-4:
    !!merge <<: *hostaccess
    !!merge <<: *exit
    environment:
      - HOPRD_API_ENDPOINT=http://host.docker.internal:13304
      - DEBUG=${DEBUG:-"rpch*"}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PRIVATE_KEY=${EXIT_NODE_PRIV_KEY_4}
    entrypoint: ["/bin/wait-for", "http://${HOPRD_API_TOKEN}@host.docker.internal:13304/api/v2/account/addresses", "-t", "300", "--", "/sbin/tini", "--"]
  exit-5:
    !!merge <<: *hostaccess
    !!merge <<: *exit
    environment:
      - HOPRD_API_ENDPOINT=http://host.docker.internal:13305
      - DEBUG=${DEBUG:-"rpch*"}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PRIVATE_KEY=${EXIT_NODE_PRIV_KEY_5}
    entrypoint: ["/bin/wait-for", "http://${HOPRD_API_TOKEN}@host.docker.internal:13305/api/v2/account/addresses", "-t", "300", "--", "/sbin/tini", "--"]
